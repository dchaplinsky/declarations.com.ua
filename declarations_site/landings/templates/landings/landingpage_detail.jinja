{% extends "base.jinja" %}


{% block extra_js %}
    {% javascript 'js_charts' %}


    <script type="text/javascript">
        function format_uah(value) {
            return accounting.formatMoney(value, "₴", 2);
        }
        function format_sqm(value) {
            return accounting.formatMoney(value, {symbol: "м²",  format: "%v %s"}, 2 )
        }

        $(function() {
            var all_data, chart;

            var customTooltips = function(tooltip) {
                var this_chart = this;
                $(this._chart.canvas).css('cursor', 'pointer');

                var positionY = this._chart.canvas.offsetTop;
                var positionX = this._chart.canvas.offsetLeft;

                $('.chartjs-tooltip').css({
                    opacity: 0,
                });

                if (!tooltip || !tooltip.opacity) {
                    return;
                }

                if (tooltip.dataPoints.length > 0) {
                    tooltip.dataPoints.forEach(function(dataPoint) {
                        var point = this_chart._data.datasets[dataPoint.datasetIndex].data[dataPoint.index];
                        var content = [dataPoint.xLabel, dataPoint.yLabel].join(': ');
                        var $tooltip = $('#main-tooltip');

                        $tooltip.find(".chartjs-tooltip__name .value").html(point.name);
                        $tooltip.find(".chartjs-tooltip__income .value").html(format_uah(point.income));
                        $tooltip.find(".chartjs-tooltip__cash .value").html(format_uah(point.cash));
                        $tooltip.find(".chartjs-tooltip__liabilities .value").html(format_uah(point.liabilities));
                        $tooltip.find(".chartjs-tooltip__expenses .value").html(format_uah(point.expenses));
                        $tooltip.find(".chartjs-tooltip__land .value").html(format_sqm(point.land));
                        $tooltip.find(".chartjs-tooltip__real_estate .value").html(format_sqm(point.real_estate));
                        $tooltip.find(".chartjs-tooltip__assets .value").html(format_uah(point.assets));


                        $tooltip.css({
                            opacity: 1,
                            top: positionY + dataPoint.y + 'px',
                            left: positionX + dataPoint.x + 'px',
                        });
                    });
                }
            };

            function build_main_chart() {
                var year = parseInt($("#year").val());
                var data = [],
                    param_x = {
                        "name": "incomes.declarant",
                        "title": "Дохід декларанта"
                    },
                    param_y = {
                        "name": "incomes.family",
                        "title": "Дохід родини"
                    },
                    param_r = {
                        "name": "assets.total",
                        "title": "Статки"
                    },

                    max_r = 0,
                    max_estate = 0,
                    options = {
                        legend: false,
                        scales: {
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: param_x.title,
                                    fontColor: "#5ECBA1",
                                    fontSize: 14,
                                    fontStyle: "bold",

                                },
                                ticks: {
                                    fontColor: "#5ECBA1",
                                    fontSize: 14,
                                    fontStyle: "bold",
                                    // Include a dollar sign in the ticks
                                    callback: function(value, index, values) {
                                        return format_uah(value);
                                    }
                                }
                            }],
                            yAxes: [{
                                scaleLabel: {
                                    fontColor: "#7175D8",
                                    fontStyle: "bold",
                                    fontSize: 14,
                                    display: true,
                                    labelString: param_y.title,
                                },
                                ticks: {
                                    fontColor: "#7175D8",
                                    fontSize: 14,
                                    fontStyle: "bold",
                                    // Include a dollar sign in the ticks
                                    callback: function(value, index, values) {
                                        return format_uah(value);
                                    }
                                }
                            }]
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: true,
                            custom: customTooltips,
                            enabled: false,

                            callbacks: {
                                label: function(tooltipItem, data) {
                                    var point = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    return (point.label || '');
                                },

                                afterLabel: function(tooltipItem, data) {
                                    var point = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    return [
                                        param_x.title + ": " + format_uah(point.x),
                                        param_y.title + ": " + format_uah(point.y),
                                        param_r.title + ": " + format_uah(point.v),
                                        "Прапорці: " + point.flags,
                                        "Загальна площа нерухомості: " + point.estate
                                    ];
                                }
                            }
                        },

                        elements: {
                            point: {
                                backgroundColor: function(context) {
                                    var value = context.dataset.data[context.dataIndex],
                                        level = value.scaled_estate,
                                        r = Math.round(255 * (1 - level) + 113 * level),
                                        g = Math.round(255 * (1 - level) + 118 * level),
                                        b = Math.round(255 * (1 - level) + 216 * level);
                                    return 'rgba(' + r + ',' + g + ',' + b + ',0.7)';
                                },

                                borderWidth: function(context) {
                                    var value = context.dataset.data[context.dataIndex];
                                    if (value.flags) {
                                        return Math.min(value.flags / 3 + 0.5, 3);
                                    }
                                    return 1
                                },

                                hoverBackgroundColor: 'transparent',

                                borderColor: function(context) {
                                    var value = context.dataset.data[context.dataIndex];
                                    if (value.flags) {
                                        return "#FF6B69";
                                    }
                                },

                                radius: function(context) {
                                    var value = context.dataset.data[context.dataIndex],
                                        size = context.chart.width;
                                    return 5 + (size / 20) * value.scaled_r;
                                }
                            }
                        }
                    };

                for (var i = 0; i < all_data["persons"].length; i++) {
                    var docs = all_data["persons"][i]["documents"];
                    for (var curr_year in docs) {
                        if (curr_year != year)
                            continue;

                        var doc = docs[curr_year],
                            x = doc["aggregated_data"][param_x.name],
                            y = doc["aggregated_data"][param_y.name],
                            r = doc["aggregated_data"][param_r.name],
                            estate = doc["aggregated_data"]["estate.total_other"];

                        if (r > max_r) {
                            max_r = r;
                        }
                        if (estate > max_estate) {
                            max_estate = estate;
                        }

                        data.push({
                            "id": all_data["persons"][i]["id"],
                            "name": all_data["persons"][i]["name"],
                            "income": doc["aggregated_data"]["incomes.total"],
                            "cash": doc["aggregated_data"]["assets.cash.total"],
                            "liabilities": doc["aggregated_data"]["liabilities.total"],
                            "expenses": doc["aggregated_data"]["expenses.total"],
                            "land": doc["aggregated_data"]["estate.total_land"],
                            "real_estate": doc["aggregated_data"]["estate.total_other"],
                            "assets": doc["aggregated_data"]["assets.total"],
                            "x": x,
                            "y": y,
                            "v": r,
                            "flags": doc["flags"].length,
                            "estate": estate,
                        });
                    }
                }

                for (var i = 0; i < data.length; i++) {
                    data[i]["scaled_r"] = (data[i]["v"] + 0.1) / (max_r + 0.1);
                    data[i]["scaled_estate"] = (Math.min(data[i]["estate"], 500) + 0.1) / (500 + 0.1);
                }

                if (typeof(chart) === "undefined") {
                    chart = new Chart('tablo', {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                "data": data
                            }]
                        },
                        options: options
                    });
                } else {
                    chart.data.datasets = [{"data": data}];
                    chart.update();
                }
            };

            $.getJSON("?format=json", function(data){
                all_data = data;

                build_main_chart();
            });

            $("#year").on("change", function() {
                build_main_chart();
            });

            $("#sort").on("change", function(){
                var order = $(this).val();

                $(".landing-page__declarants-table").each(function(i, table) {
                    table = $(table);
                    var items = table.find('tbody tr');

                    items.sort(function(a, b) {
                        switch (order) {
                            case "assets":
                            case "flags":
                                return parseFloat($(b).data(order)) - parseFloat($(a).data(order));
                            break;
                            case "name":
                                return $(a).data(order).localeCompare($(b).data(order));
                            break;
                        }
                        
                    });
                        
                    items.appendTo(table.find("tbody"));
                });

            });

        });
    </script>
{% endblock %}

{% macro format_trend(prev_val, val, symbol) %}
    {% if prev_val %}
        {% if prev_val > val %}
            <span class="minus" title="{{ _("Попередній період: ")}} {{ symbol }} {{ prev_val|string|curformat() }}">-&nbsp;{{ '{0:0.2f}'.format((prev_val - val) / (prev_val) * 100) }}%</span>
        {% elif prev_val < val %}
            <span class="plus" title="{{ _("Попередній період: ")}} {{ symbol }} {{ prev_val|string|curformat() }}">+&nbsp;{{ '{0:0.2f}'.format((val - prev_val) / (prev_val) * 100) }}%</span>
        {% else %}
            <span class="no_change"></span>
        {% endif %}
    {% else %}
        {% if val %}
            <span class="plus">+++</span>
        {% else %}
            <span class="no_change"></span>
        {% endif %}
    {% endif %}
{% endmacro %}

{% block content %}

    <div class="content container">
        <div class="search-card search-page__result-card">
            <div class="search-card__top">
                <div class="search-card__name">
                    {{ object.title }}
                </div>
            </div>

            <div class="search-card__items">
                <div class="search-card__item">
                    <div class="search-card__item-text gray_text">
                        {% if object.image %}
                        <img src="{{ object.image['avatar'].url }}" alt="{{ object.title }}"/>
                        {% endif %}
                        {{ object.description|safe }}
                    </div>
                </div>
            </div>
        </div>

        <div class="search-card search-page__result-card">
            <div class="search-card__top">
                <div class="search-card__name">
                    {{ _("Установа") }}
                </div>
                {# <div class="n-select">
                    <div class="n-select__selected">{{ CURR_YEAR - 1 }}</div>
                    <div class="n-select__items">
                        {% for year in range(summary.min_year, summary.max_year + 1) %}
                            <div class="n-select__item{% if year == CURR_YEAR - 1 %} n-select__item_active{% endif %}">{{ year }}</div>
                        {% endfor %}
                    </div>
                </div> #}
                <select id="year" style="display: none;">
                    {% for year in range(summary.min_year, summary.max_year + 1) %}
                        <option value="{{ year }}" {% if year == CURR_YEAR - 1 %}selected="selected"{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="search-card__items">
                <div class="search-card__item">
                    <canvas id="tablo"></canvas>
                    <div class="chartjs-tooltip" id="main-tooltip">
                        <div class="chartjs-tooltip__body">
                            <div class="chartjs-tooltip__name"><span class="value"></span></div>
                            <div class="chartjs-tooltip__legend">
                                <div class="chartjs-tooltip__income"><span>{{ _("Дохід") }}</span><span class="value"></span></div>
                                <div class="chartjs-tooltip__cash"><span>{{ _("Кеш") }}</span><span class="value"></span></div>
                                <div class="chartjs-tooltip__liabilities"><span>{{ _("Борги") }}</span><span class="value"></span></div>
                                <div class="chartjs-tooltip__expenses"><span>{{ _("Витрати") }}</span><span class="value"></span></div>
                                <div class="chartjs-tooltip__real_estate"><span>{{ _("Нерухомість") }}</span><span class="value"></span></div>
                                <div class="chartjs-tooltip__land"><span>{{ _("Земля") }}</span><span class="value"></span></div>
                            </div>
                        </div>
                        <div class="chartjs-tooltip__footer">
                            <div class="chartjs-tooltip__assets">{{ _("Загальні статки") }}</span><span class="value"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="search-card search-page__result-card landing-page__people">
            <div class="search-card__top">
                <div class="sort-block">
                    <div class="sort-block__title">{{ _("Сортувати по:") }}</div>
                    <div class="sort-block__select">
                        <select id="sort">
                            <option selected="selected" value="assets">{{ _("Найбільш багаті") }}</option>
                            <option value="flags">{{ _("Найбільше ризиків") }}</option>
                            <option value="name">{{ _("За ПІБ") }}</option>
                        </select>
                    </div>
                </div>
                <a href="?format=xlsx" class="n-btn n-btn_white landing-page__export">{{ _("експорт в excel") }}</a>
            </div>

            <div class="search-card__items">
                <div class="search-card__item">
                    {% for year in range(summary.min_year, summary.max_year + 1) %}
                    <table id="declarants-{{ year }}" {% if year != CURR_YEAR - 1 %}style="display: none"{% endif %} class="n-table landing-page__declarants-table">
                        <thead class="n-table__thead">
                            <tr>
                                <th class="n-table__th">{{ _("Повне ім’я") }}</th>
                                <th class="n-table__th">{{ _("Ризики") }}</th>
                                <th class="n-table__th">{{ _("Доходи") }}</th>
                                <th class="n-table__th">{{ _("Активи") }}</th>
                                <th class="n-table__th">{{ _("Авто") }}</th>
                                <th class="n-table__th">{{ _("Нерухомість") }}</th>
                                <th class="n-table__th">{{ _("Земля") }}</th>
                            </tr>
                        </thead>
                        <tbody class="n-table__tbody">
                            {% for person in summary.persons %}
                                {% set doc = person.documents[year] %}
                                {% if year in person.documents %}
                                    <tr class="n-table__tr"
                                        data-name="{{ person.name }}"
                                        data-assets="{% if 'assets.total' in doc.aggregated_data %}{{ doc.aggregated_data['assets.total'] }}{% else %}-1{% endif %}"
                                        data-flags="{{ doc.flags|count }}"
                                        >
                                        <td class="n-table__td">
                                            <a href="{{ person.id }}">{{ person.name }}</a>
                                        </td>
                                        <td class="n-table__td landing-page__declarants-table-flags">{%- if doc.flags|count %}
                                            {{ doc.flags|count }}
                                        {% endif -%}</td>
                                        <td class="n-table__td landing-page__declarants-table-money-with-trend n-tooltip__trigger">
                                            {% if 'incomes.total' in doc.aggregated_data %}
                                                {% set val = doc.aggregated_data["incomes.total"] %}
                                                <span class="landing-page__declarants-table-amount">
                                                    ₴ {{ val|string|curformat() }}
                                                </span>
                                                {% if year - 1 in person.documents %}
                                                    {% set prev_val = person.documents[year - 1].aggregated_data["incomes.total"] %}
                                                    {{ format_trend(prev_val, val, "₴") }}
                                                {% endif %}
                                            {% endif %}
                                            <div class="n-tooltip">
                                                <div class="n-tooltip__head">
                                                    <div class="n-tooltip__title">{{ _("Доходи") }}</div>
                                                </div>
                                                <div class="n-tooltip__body">
                                                    <canvas />
                                                </div>
                                            </div>
                                        </td>
                                        <td class="n-table__td landing-page__declarants-table-money-with-trend">
                                            {% if 'assets.total' in doc.aggregated_data %}
                                                {% set val = doc.aggregated_data["assets.total"] %}
                                                <span class="landing-page__declarants-table-amount">
                                                    ₴ {{ val|string|curformat() }}
                                                </span>
                                                {% if year - 1 in person.documents %}
                                                    {% set prev_val = person.documents[year - 1].aggregated_data["assets.total"] %}
                                                    {{ format_trend(prev_val, val, "₴") }}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="n-table__td">
                                            {% if 'vehicles.all_names' in doc.aggregated_data %}
                                                {% if doc.aggregated_data["vehicles.all_names"] %}
                                                    {{ doc.aggregated_data["vehicles.all_names"]|replace("; ", "<br/>")|safe }}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="n-table__td">
                                            {% if 'estate.total_other' in doc.aggregated_data %}
                                                {% set val = person.documents[year].aggregated_data["estate.total_other"] %}
                                                <span class="landing-page__declarants-table-amount">
                                                    {{ val|string|curformat() }}{{ _("м²") }}
                                                </span>
                                                {% if year - 1 in person.documents %}
                                                    {% set prev_val = person.documents[year - 1].aggregated_data["estate.total_other"] %}
                                                    {{ format_trend(prev_val, val, _("м²")) }}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="n-table__td">
                                            {% if 'estate.total_land' in doc.aggregated_data %}
                                                {% set val = person.documents[year].aggregated_data["estate.total_land"] %}
                                                <span class="landing-page__declarants-table-amount">
                                                    {{ val|string|curformat() }}{{ _("м²") }}
                                                </span>
                                                {% if year - 1 in person.documents %}
                                                    {% set prev_val = person.documents[year - 1].aggregated_data["estate.total_land"] %}
                                                    {{ format_trend(prev_val, val, _("м²")) }}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            {% for person in summary.persons %}
                                {% if year not in person.documents %}
                                    <tr class="n-table__tr"
                                        data-name="{{ person.name }}"
                                        data-assets="-1"
                                        data-flags="-">
                                        <td class="n-table__td">
                                            <a href="{{ person.id }}">{{ person.name }}</a>
                                        </td>
                                        <td class="n-table__td">-</td>
                                        <td class="n-table__td">-</td>
                                        <td class="n-table__td">-</td>
                                        <td class="n-table__td">-</td>
                                        <td class="n-table__td">-</td>
                                        <td class="n-table__td">-</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                </div>
            </div>
        </div>

            {# <tbody>
                {% for person in summary.persons %}
                <tr>

                    {% if year in person.documents %}
                        <td>
                            <a href="{{ person.id }}">{{ person.name }}</a>
                        </td>
                        {% set doc = person.documents[year] %}
                        <td>{{ doc.flags|count }}</td>
                        <td>
                            {% set val = doc.aggregated_data["incomes.total"] %}
                            ₴ {{ val|string|curformat() }}
                            {% if year - 1 in person.documents %}
                                {% set prev_val = person.documents[year - 1].aggregated_data["incomes.total"] %}
                                {{ format_trend(prev_val, val, "₴") }}
                            {% endif %}
                        </td>
                        <td>
                            {% set val = person.documents[year].aggregated_data["assets.total"] %}
                            ₴ {{ val|string|curformat() }}
                            {% if year - 1 in person.documents %}
                                {% set prev_val = person.documents[year - 1].aggregated_data["assets.total"] %}
                                {{ format_trend(prev_val, val, "₴") }}
                            {% endif %}
                        </td>
                        <td>{{ doc.aggregated_data["vehicles.all_names"]|replace("; ", "<br/>")|safe }}</td>
                        <td>
                            {% set val = person.documents[year].aggregated_data["estate.total_other"] %}
                            {{ val|string|curformat() }}{{ _("м²") }}
                            {% if year - 1 in person.documents %}
                                {% set prev_val = person.documents[year - 1].aggregated_data["estate.total_other"] %}
                                {{ format_trend(prev_val, val, _("м²")) }}
                            {% endif %}
                        </td>
                        <td>
                            {% set val = person.documents[year].aggregated_data["estate.total_land"] %}
                            {{ val|string|curformat() }}{{ _("м²") }}
                            {% if year - 1 in person.documents %}
                                {% set prev_val = person.documents[year - 1].aggregated_data["estate.total_land"] %}
                                {{ format_trend(prev_val, val, _("м²")) }}
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% for person in summary.persons %}
                {% if year not in person.documents %}
                    <tr>
                        <td>
                            <a href="{{ person.id }}">{{ person.name }}</a>
                        </td>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                {% endif %}
                {% endfor %}

            </tbody>
        </table>
        {% endfor %} #}
    </div>
    <style type="text/css">
        #tablo {
            width: 100%;
            height: 400px;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
        }

        .gray_text {
            font-family: Inter;
            font-style: normal;
            font-weight: 500;
            font-size: 16px;
            line-height: 24px;
            max-width: 100%;
            color: #898D93;
        }
        .search-card__item-text img {
            float: left;
            padding-right: 10px;
        }
        .minus {
            color: red;
        }
        .plus {
            color: green;
        }
    </style>
{% endblock %}